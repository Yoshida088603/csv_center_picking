# ポリゴン境界での幅1cmライン描画（要件）

## 1. 概要

| 項目 | 内容 |
|------|------|
| **目的** | 入力点群の上に、指定ポリゴンに沿った**幅1cmのマゼンタ線**を描く。 |
| **入力** | 点群（LAS/LAZ・数学座標系）、境界ポリゴン（SIMA形式 .sim・1閉多角形） |
| **出力** | 全点を保持した1つの LAS。帯の点のみマゼンタ（R=65535, G=0, B=65535）で幅1cmの線として見える。**内側・帯・外側でクラス分け**（Classification フィールドで区別）して出力する。 |

**前提**: SIMA＝測量座標系、点群＝数学座標系。参照リポジトリ **dxf4segmentation** は完全に動作確認済み。その機能を可能な限りそのまま使い、後段のみ当方で実装する。

---

## 2. 処理構成（前段 ＋ 後段）

```
[.sim] → 前段（参照元そのまま） → 中心・内側・外側の3ポリゴン
                                              ↓
[LAS/LAZ] → 後段（当方実装） → 座標合わせ → 3領域分類 → 帯をマゼンタ → クラス設定 → マージ → [LAS]
```

- **前段**: SIMA パース → オフセット（内側5mm・外側5mm）。参照元のコード・ロジックを**そのまま**使用。再開発しない。
- **後段**: 点群読み込み、前段の3ポリゴンを使った**切り抜き・帯の着色**、LAS 出力。座標変換は参照元の「XY反転」ルールを流用。

---

## 3. 前段（参照元をそのまま利用）

| # | 処理 | 内容 |
|---|------|------|
| 1 | SIMA パース | 参照元の `parseSim` をそのまま使う。`.sim` → ポリゴン `[[x,y],...]`（測量座標系）。 |
| 2 | オフセット | 参照元の `offsetPolygon` をそのまま使う。内側5mm＝`offsetPolygon(poly, -0.005)`、外側5mm＝`offsetPolygon(poly, 0.005)`。Clipper.js も参照元と同じ。 |
| 3 | 出力 | **中心**（元ポリゴン）、**内側オフセット**、**外側オフセット**の3ポリゴン。いずれも参照元と同じ座標系・ロジック。 |

---

## 4. 後段（点群の切り抜き・着色）

| # | 処理 | 内容 |
|---|------|------|
| 1 | 座標系合わせ | 前段の3ポリゴンを数学座標系に変換。参照元の「DXF出力時XY反転」と同じルール（SIMAのX→数学のY、SIMAのY→数学のX）。新規開発しない。 |
| 2 | 3領域分類 | 数学座標系のポリゴンで各点を判定。**内側**＝内側オフセットの内側、**帯**＝外側オフセットの内側かつ内側オフセットの外側（幅1cm）、**外側**＝外側オフセットの外側。 |
| 3 | 着色 | 帯の点のみ RGB をマゼンタ（R=65535, G=0, B=65535、16bit）に変更。 |
| 4 | クラス設定 | 各点の Classification に領域を設定。内側・帯・外側を別クラス値で記録（クラス番号は実装時に決定）。 |
| 5 | 出力 | 内側・帯・外側をマージして1つの LAS として出力。出力 LAS は内側・帯・外側でクラス分けされている。 |

---

## 5. 参照リポジトリの流用方針（dxf4segmentation）

- **配置**: ワークスペース内 `dxf4segmentation/`（参照用に配置済み）。

| 区分 | 対象 | 場所 | 方針 |
|------|------|------|------|
| **前段でそのまま使う** | Clipper.js | CDN | `https://cdn.jsdelivr.net/npm/clipper-lib@6.4.2/clipper.js` を同じく読み込む。 |
| | parseSim | index.html 20–36行目 | .sim → `[[x,y],...]`。そのままコピーして使用。 |
| | offsetPolygon | index.html 56–64行目 | スケール・jtMiter・etClosedPolygon 等そのまま。内側/外側5mmの算出に使用。 |
| **後段で流用するルール** | 測量→数学（XY反転） | polygonToDxf 内 10=y, 20=x | 3ポリゴンの頂点を [simaY, simaX] に変換。ルールのみ流用、実装は当方。 |
| **使わない** | polygonToDxf / download | 39–53行目 | DXF 出力用のため不要。XY反転の**ルール**は後段で上記のとおり流用。 |

---

## 6. 未決定・備考

- オフセット量（5mm/5mm）を参照元と同じ固定とするか、ユーザー指定とするかは実装時に決定する。
- Classification のクラス番号（内側・帯・外側に割り当てる 0–255 の値）は実装時に決定する。
